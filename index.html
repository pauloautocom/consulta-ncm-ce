<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM â€¢ CClassTrib â€¢ CST</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f6f8;padding:15px;}
h1{text-align:center;}
input{width:100%;padding:14px;font-size:16px;margin-bottom:12px;}
table{width:100%;border-collapse:collapse;background:#fff;}
th,td{padding:8px;border:1px solid #ccc;font-size:14px;}
th{background:#2563eb;color:#fff;}
.msg{text-align:center;color:#555;margin-top:10px;}
@media(max-width:600px){
  th,td{font-size:12px;}
}
</style>
</head>
<body>

<h1>Consulta NCM â€¢ CClassTrib â€¢ CST</h1>

<input id="busca"
 placeholder="Digite: cerveja, coca cola, Ã¡gua mineral ou NCM"
 oninput="buscar()" />

<table>
<thead>
<tr>
<th>NCM</th>
<th>DescriÃ§Ã£o</th>
<th>CClassTrib</th>
<th>CST</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
function norm(t){
 return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

// nomes comerciais (expansÃ­vel)
const nomes = [
 {termos:["cerveja"], ncm:"22030000"},
 {termos:["agua","mineral"], ncm:"22011000"},
 {termos:["agua"], ncm:"22011000"},
 {termos:["refrigerante"], ncm:"22021000"},
 {termos:["coca","cola"], ncm:"22021000"}
];

function fiscal(){
 return {cclasstrib:"000001", cst:"000"};
}

let base=[];

fetch("ncm.json")
 .then(r=>r.json())
 .then(d=>{
  base = d.map(i=>({
   ncm:String(i.NCM||i.ncm||"").padStart(8,"0"),
   desc:i.Descricao||i.descricao||""
  }));
 });

function buscar(){
 const v = document.getElementById("busca").value;
 const termo = norm(v);
 const res = document.getElementById("resultado");
 const msg = document.getElementById("msg");
 res.innerHTML=""; msg.innerText="";

 // ðŸ”´ NÃƒO MOSTRA ERRO COM MENOS DE 3 CARACTERES
 if(termo.length < 3) return;

 let prefixoNCM = null;

 // se digitou nÃºmero
 const soNum = termo.replace(/\D/g,"");
 if(soNum.length >= 2) prefixoNCM = soNum;

 // nome comercial
 if(!prefixoNCM){
  for(const n of nomes){
   if(n.termos.every(t=>termo.includes(t))){
    prefixoNCM = n.ncm.substring(0,4);
    break;
   }
  }
 }

 const achou = base.filter(i=>{
  const d = norm(i.desc);
  return (
    (prefixoNCM && i.ncm.startsWith(prefixoNCM)) ||
    d.includes(termo)
  );
 });

 if(achou.length === 0){
  msg.innerText="Nenhum resultado encontrado";
  return;
 }

 achou.slice(0,50).forEach(i=>{
  const f = fiscal(i.ncm);
  res.innerHTML+=`
<tr>
<td>${i.ncm}</td>
<td>${i.desc}</td>
<td>${f.cclasstrib}</td>
<td>${f.cst}</td>
</tr>`;
 });
}
</script>

</body>
</html>
