<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM + CClassTrib (CE)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:15px; }
.card {
  max-width:760px; margin:auto; background:#fff;
  padding:20px; border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,.1);
}
h1 { font-size:20px; }
input {
  width:100%; padding:12px; font-size:16px; margin-top:10px;
}
.resultado { margin-top:15px; }
.item {
  padding:10px; border-bottom:1px solid #ddd;
}
.badge {
  display:inline-block; padding:4px 8px;
  background:#2563eb; color:#fff;
  border-radius:6px; font-size:12px;
  margin-right:6px;
}
.nao { background:#999; }
.small { font-size:12px; color:#666; }
</style>
</head>

<body>

<div class="card">
<h1>Consulta Fiscal – Ceará</h1>
<p class="small">Busca por nome ou NCM • Base oficial + nomes fáceis</p>

<input id="busca" placeholder="Ex: água mineral, cerveja, arroz, 22011000">

<div id="resultado" class="resultado"></div>
</div>

<script>
// ========================
// BASE FÁCIL (nomes comerciais)
// ========================
const baseFacil = [
  { ncm:"22011000", nomes:["agua","agua mineral","água mineral"], produto:"Água mineral" },
  { ncm:"22021000", nomes:["refrigerante","coca cola","coca-cola","guarana"], produto:"Refrigerante" },
  { ncm:"22030000", nomes:["cerveja"], produto:"Cerveja" },
  { ncm:"10063021", nomes:["arroz"], produto:"Arroz" },
  { ncm:"07133329", nomes:["feijao","feijão"], produto:"Feijão" },
  { ncm:"19021900", nomes:["macarrao","macarrão"], produto:"Macarrão" },
  { ncm:"09012100", nomes:["cafe","café"], produto:"Café" },
  { ncm:"96081000", nomes:["caneta"], produto:"Caneta esferográfica" },
  { ncm:"85444200", nomes:["cabo usb","usb"], produto:"Cabo USB" }
];

// ========================
// CCLASSTRIB – CE (modelo correto)
// ========================
const regrasCE = [
  { inicio:"2201", cclasstrib:"000010", cst:"010", desc:"Água mineral" },
  { inicio:"2202", cclasstrib:"000020", cst:"000", desc:"Bebidas – ST" },
  { inicio:"2203", cclasstrib:"000020", cst:"000", desc:"Cervejas – ST" },
  { inicio:"1006", cclasstrib:"000030", cst:"010", desc:"Cesta básica" },
  { inicio:"0713", cclasstrib:"000030", cst:"010", desc:"Cesta básica" }
];

let tabelaNCM = [];

// ========================
// CARREGA TABELA OFICIAL
// ========================
fetch("tabelancm.json")
  .then(r => r.json())
  .then(d => tabelaNCM = d)
  .catch(() => console.warn("Tabela NCM não carregada"));

// ========================
function normalizar(t){
  return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

// ========================
document.getElementById("busca").addEventListener("input", e => {
  const q = normalizar(e.target.value.trim());
  const div = document.getElementById("resultado");
  div.innerHTML = "";

  if(q.length < 2) return;

  let resultados = [];

  // 1️⃣ BASE FÁCIL
  baseFacil.forEach(p => {
    if (
      p.ncm.startsWith(q) ||
      p.nomes.some(n => normalizar(n).includes(q))
    ) {
      resultados.push({
        produto:p.produto,
        ncm:p.ncm
      });
    }
  });

  // 2️⃣ BASE OFICIAL (se não achou nada)
  if(resultados.length === 0 && tabelaNCM.length){
    tabelaNCM.forEach(p => {
      if (
        p.codigo.replace(/\D/g,"").startsWith(q) ||
        normalizar(p.descricao).includes(q)
      ) {
        resultados.push({
          produto:p.descricao,
          ncm:p.codigo
        });
      }
    });
  }

  if(resultados.length === 0){
    div.innerHTML = "<p class='small'>Nenhum resultado encontrado.</p>";
    return;
  }

  resultados.slice(0,20).forEach(p => {
    const regra = regrasCE.find(r => p.ncm.startsWith(r.inicio));

    div.innerHTML += `
      <div class="item">
        <b>${p.produto}</b><br>
        NCM: ${p.ncm}<br>
        <span class="badge">
          CClassTrib: ${regra ? regra.cclasstrib : "Não definido"}
        </span>
        <span class="badge ${regra ? "" : "nao"}">
          CST: ${regra ? regra.cst : "—"}
        </span>
        <div class="small">${regra ? regra.desc : "Sem regra específica CE"}</div>
      </div>
    `;
  });
});
</script>

</body>
</html>
