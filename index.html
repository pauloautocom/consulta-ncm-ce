<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta NCM e CClassTrib - CE</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 15px;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}
h1 {
  text-align: center;
  margin-bottom: 15px;
}
input {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-bottom: 15px;
}
.result {
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}
.result:last-child {
  border-bottom: none;
}
.label {
  font-weight: bold;
}
.loading {
  color: #555;
  font-style: italic;
}
.notfound {
  color: red;
}
</style>
</head>

<body>
<div class="container">
<h1>Consulta NCM / CClassTrib â€“ CearÃ¡</h1>

<input type="text" id="search" placeholder="Digite nome do produto ou NCM (ex: Ã¡gua mineral, cerveja, 22011000)">

<div id="status" class="loading">Carregando basesâ€¦</div>
<div id="results"></div>
</div>

<script>
let ncmBase = [];
let cclassBase = [];
let indexBusca = [];

const CST_MAP = {
  "000": "TributaÃ§Ã£o integral",
  "010": "TributaÃ§Ã£o com alÃ­quota uniforme",
  "020": "TributaÃ§Ã£o com reduÃ§Ã£o de base",
  "030": "Isenta",
  "040": "NÃ£o tributada",
  "050": "SuspensÃ£o",
  "060": "Diferimento"
};

// ðŸ”¹ Base de nomes fÃ¡ceis (mercantil)
const aliases = [
  { nome: "Ã¡gua mineral", ncm: "22011000" },
  { nome: "refrigerante", ncm: "22021000" },
  { nome: "coca cola", ncm: "22021000" },
  { nome: "cerveja", ncm: "22030000" },
  { nome: "arroz", ncm: "10063021" },
  { nome: "feijÃ£o", ncm: "07133329" },
  { nome: "macarrÃ£o", ncm: "19021900" },
  { nome: "biscoito", ncm: "19053100" },
  { nome: "cafÃ©", ncm: "09012100" },
  { nome: "Ã³leo de soja", ncm: "15071000" },
  { nome: "caneta esferogrÃ¡fica", ncm: "96081000" },
  { nome: "lÃ¡pis", ncm: "96091000" },
  { nome: "cabo usb", ncm: "85444200" },
  { nome: "camisa algodÃ£o", ncm: "61051000" }
];

async function carregarDados() {
  try {
    const ncmResp = await fetch("tabelancm.json");
    ncmBase = await ncmResp.json();

    const cclassResp = await fetch("cclasstrib.json");
    cclassBase = await cclassResp.json();

    montarIndice();

    document.getElementById("status").innerText =
      "Bases carregadas. Digite para pesquisar.";
  } catch (e) {
    document.getElementById("status").innerText =
      "Erro ao carregar arquivos JSON.";
  }
}

function montarIndice() {
  indexBusca = [];

  ncmBase.forEach(item => {
    indexBusca.push({
      nome: item.descricao.toLowerCase(),
      ncm: item.ncm
    });
  });

  aliases.forEach(a => {
    indexBusca.push({
      nome: a.nome.toLowerCase(),
      ncm: a.ncm
    });
  });
}

function buscar() {
  const termo = document.getElementById("search").value.trim().toLowerCase();
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if (termo.length < 2) return;

  const encontrados = indexBusca.filter(item =>
    item.nome.includes(termo) || item.ncm.startsWith(termo)
  ).slice(0, 20);

  if (encontrados.length === 0) {
    resultsDiv.innerHTML =
      "<div class='notfound'>Nenhum resultado encontrado</div>";
    return;
  }

  encontrados.forEach(item => {
    const ncmInfo = ncmBase.find(n => n.ncm === item.ncm);
    const cclass = cclassBase.find(c => item.ncm.startsWith(c.ncm_inicio));

    const cclassCod = cclass ? cclass.cclasstrib : "â€”";
    const cst = cclass ? cclass.cst : "â€”";
    const cstDesc = CST_MAP[cst] || "";

    const div = document.createElement("div");
    div.className = "result";
    div.innerHTML = `
      <div><span class="label">Produto:</span> ${ncmInfo ? ncmInfo.descricao : item.nome}</div>
      <div><span class="label">NCM:</span> ${item.ncm}</div>
      <div><span class="label">CClassTrib (CE):</span> ${cclassCod}</div>
      <div><span class="label">CST p/ CClassTrib:</span> ${cst} ${cstDesc}</div>
    `;
    resultsDiv.appendChild(div);
  });
}

document.getElementById("search").addEventListener("input", buscar);
carregarDados();
</script>
</body>
</html>
