<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM • CClassTrib • CST</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:12px; }
h1 { text-align:center; font-size:20px; }
input { width:100%; padding:14px; font-size:16px; margin-bottom:12px; }
table { width:100%; border-collapse:collapse; background:#fff; }
th,td { border:1px solid #ccc; padding:8px; font-size:14px; }
th { background:#1e40af; color:#fff; }
tr:nth-child(even){ background:#eef2f7; }
.msg { text-align:center; margin-top:10px; color:#555; }
@media(max-width:600px){ th,td{ font-size:12px; }}
</style>
</head>
<body>

<h1>Consulta NCM • CST • cClassTrib</h1>

<input id="busca"
 placeholder="Digite produto ou NCM (ex: biscoito, 2201)"
 oninput="buscar()" />

<table>
<thead>
<tr>
 <th>NCM</th>
 <th>Descrição</th>
 <th>CST</th>
 <th>cClassTrib</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
// normaliza texto (remove acentos)
function norm(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();}

// regras CST + cClassTrib oficiais (simplificadas)
function regraFiscal(ncm){
  // Exemplo básico por tipo de produto
  if(ncm.startsWith("22")) {
    // bebidas → Substitutiva
    return {cst:"060", cclasstrib:"000002"}; // CST 060 e cClassTrib 000002
  }
  // alimentos em geral e mercantil
  return {cst:"000", cclasstrib:"000001"}; // CST 000 e cClassTrib 000001
}

// base mercantil reduzida para fallback
const baseLocal = [
  {ncm:"22011000",desc:"Água mineral"},
  {ncm:"22021000",desc:"Refrigerante"},
  {ncm:"22030000",desc:"Cerveja"},
  {ncm:"10063021",desc:"Arroz"},
  {ncm:"07133319",desc:"Feijão"},
  {ncm:"19053100",desc:"Biscoito"}
];

let baseCompleta = [...baseLocal];

// carrega JSON oficial (com NCM/Descricao)
fetch("ncm.json")
  .then(r=>r.json())
  .then(d=>{
    d.forEach(i=>{
      if(i.ncm && i.descricao){
        baseCompleta.push({
          ncm:String(i.ncm).padStart(8,"0"),
          desc:i.descricao
        });
      }
    });
  })
  .catch(()=>console.warn("JSON não carregou"));

function buscar(){
  const v=document.getElementById("busca").value;
  const termo=norm(v);
  const tbody=document.getElementById("resultado");
  const msg=document.getElementById("msg");
  tbody.innerHTML=""; msg.innerText="";

  if(termo.length<2) return;

  const num=termo.replace(/\D/g,"");

  const achou=baseCompleta.filter(i=>{
    return (num && i.ncm.startsWith(num)) || norm(i.desc).includes(termo);
  });

  if(achou.length===0){
    msg.innerText="Nenhum resultado encontrado";
    return;
  }

  achou.slice(0,50).forEach(i=>{
    const regra=regraFiscal(i.ncm);
    tbody.innerHTML+=`
<tr>
 <td>${i.ncm}</td>
 <td>${i.desc}</td>
 <td>${regra.cst}</td>
 <td>${regra.cclasstrib}</td>
</tr>`;
  });
}
</script>

</body>
</html>
