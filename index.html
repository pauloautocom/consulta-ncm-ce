<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM – CClassTrib – CST</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  background: #f4f6f8;
}
h1 {
  text-align: center;
}
input {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin: 12px 0;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  padding: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
}
th {
  background: #2563eb;
  color: #fff;
}
tr:nth-child(even) {
  background: #eef2f7;
}
.msg {
  text-align: center;
  color: #444;
  margin-top: 12px;
}
@media (max-width: 600px) {
  th, td {
    font-size: 12px;
    padding: 8px;
  }
}
</style>
</head>
<body>

<h1>Consulta NCM / CClassTrib / CST</h1>

<input id="busca"
  placeholder="Digite: água mineral, cerveja, coca cola ou NCM"
  oninput="buscar()" />

<table>
<thead>
<tr>
  <th>NCM</th>
  <th>Descrição Oficial</th>
  <th>CClassTrib</th>
  <th>CST p/ CClassTrib</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
// Normaliza texto (remove acentos e caixa)
function normaliza(txt) {
  return txt.toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .trim();
}

// BASE COMERCIAL MANUAL (mapeia termos para NCMs comuns)
const nomesComerciais = [
  { termos: ["agua","mineral"], ncm: "22011000" },
  { termos: ["agua"], ncm: "22011000" },
  { termos: ["refrigerante"], ncm: "22021000" },
  { termos: ["coca","cola"], ncm: "22021000" },
  { termos: ["guarana"], ncm: "22021000" },
  { termos: ["cerveja"], ncm: "22030000" },
  { termos: ["cerveja","lata"], ncm: "22030000" },
  { termos: ["cerveja","pilsen"], ncm: "22030000" }
];

// Regras padrão de CClassTrib + CST (exemplo didático)
function regraFiscal(ncm) {
  // Aqui você pode mapear por NCM se quiser regras diferentes
  return {
    cclasstrib: "000001", // exemplo
    cst: "000"
  };
}

let baseNCM = [];

// Carrega JSON oficial
fetch("./ncm.json")
  .then(res => res.json())
  .then(dados => {
    // Ajusta campos de diferentes formatos do JSON oficial
    baseNCM = dados.map(item => ({
      ncm: String(item.ncm || item.NCM || item.codigo || item.Codigo || "").padStart(8, "0"),
      descricao: item.descricao || item.Descricao || item.DESCRICAO || ""
    }));
  })
  .catch(() => {
    document.getElementById("msg").innerText = 
      "Erro ao carregar ncm.json. Verifique se o arquivo está acessível.";
  });

function buscar() {
  const txt = document.getElementById("busca").value;
  const termo = normaliza(txt);
  const tbody = document.getElementById("resultado");
  const msg = document.getElementById("msg");

  tbody.innerHTML = "";
  msg.innerText = "";

  if (termo.length < 2) return;

  let ncmForcado = null;

  // Se for NCM numérico
  const soNums = termo.replace(/\D/g, "");
  if (soNums.length >= 2) {
    ncmForcado = soNums;
  }

  // Mapeia nome comercial
  if (!ncmForcado) {
    for (const item of nomesComerciais) {
      if (item.termos.every(t => termo.includes(t))) {
        ncmForcado = item.ncm;
        break;
      }
    }
  }

  const encontrados = baseNCM.filter(item => {
    const descNorm = normaliza(item.descricao);
    return (
      (ncmForcado && item.ncm.startsWith(ncmForcado)) ||
      descNorm.includes(termo)
    );
  });

  if (encontrados.length === 0) {
    msg.innerText = "Nenhum resultado encontrado";
    return;
  }

  encontrados.slice(0, 50).forEach(item => {
    const reg = regraFiscal(item.ncm);
    tbody.innerHTML += `
<tr>
  <td>${item.ncm}</td>
  <td>${item.descricao}</td>
  <td>${reg.cclasstrib}</td>
  <td>${reg.cst}</td>
</tr>`;
  });
}
</script>

</body>
</html>
