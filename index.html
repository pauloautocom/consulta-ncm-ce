<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta NCM e CClassTrib ‚Äì CE</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:10px; }
h1 { text-align:center; font-size:20px; }
input { width:100%; padding:14px; font-size:16px; margin-bottom:10px; }
.card {
  background:#fff; padding:12px; border-radius:6px;
  margin-bottom:8px; box-shadow:0 2px 4px rgba(0,0,0,.1);
}
.ok { color:green; font-weight:bold; }
.warn { font-size:13px; color:#555; }
.small { font-size:13px; color:#777; }
</style>
</head>

<body>

<h1>Consulta NCM ‚Äì Cear√°</h1>

<input id="busca" placeholder="Produto ou NCM (ex: arroz, cerveja, 22011000)" />

<div id="resultado" class="small">Digite para pesquisar.</div>

<script>
// ================= BASE CE (R√ÅPIDA) =================
const baseCE = [
  { nome:"√Ågua mineral", ncm:"22011000", cclasstrib:"000010", cst:"010" },
  { nome:"Refrigerante", ncm:"22021000", cclasstrib:"000010", cst:"010" },
  { nome:"Cerveja", ncm:"22030000", cclasstrib:"000010", cst:"010" },
  { nome:"Arroz", ncm:"10063021", cclasstrib:"000001", cst:"000" },
  { nome:"Feij√£o", ncm:"07133399", cclasstrib:"000001", cst:"000" },
  { nome:"Macarr√£o", ncm:"19021900", cclasstrib:"000001", cst:"000" },
  { nome:"Biscoito", ncm:"19053100", cclasstrib:"000001", cst:"000" },
  { nome:"Caneta esferogr√°fica", ncm:"96081000", cclasstrib:"000003", cst:"000" },
  { nome:"Cabo USB", ncm:"85444200", cclasstrib:"000003", cst:"000" },
  { nome:"Camisa algod√£o", ncm:"61091000", cclasstrib:"000003", cst:"000" }
];

// ================= TABELA OFICIAL =================
let tabelaNCM = [];
let carregada = false;

fetch("tabelancm.json")
  .then(r => r.json())
  .then(d => {
    tabelaNCM = d.map(n => ({
      ncm: String(n.ncm).replace(/\D/g,""),
      descricao: n.descricao || ""
    }));
    carregada = true;
  });

// ================= UTIL =================
function normalizar(txt){
  return txt.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"");
}

// ================= BUSCA =================
let timer;
document.getElementById("busca").addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(buscar, 300);
});

function buscar(){
  const termo = document.getElementById("busca").value.trim();
  const res = document.getElementById("resultado");
  res.innerHTML = "";

  if (termo.length < 2){
    res.innerHTML = "Digite pelo menos 2 caracteres.";
    return;
  }

  const termoN = normalizar(termo);
  const termoNum = termo.replace(/\D/g,"");

  // üîπ 1) BUSCA CE (S√ì SE HOUVER MATCH REAL)
  const ceResultados = baseCE.filter(p =>
    normalizar(p.nome).includes(termoN) ||
    (termoNum && p.ncm.startsWith(termoNum))
  );

  if (ceResultados.length > 0){
    ceResultados.forEach(p=>{
      res.innerHTML += `
      <div class="card">
        <strong>${p.nome}</strong><br>
        NCM: ${p.ncm}<br>
        CClassTrib (CE): <span class="ok">${p.cclasstrib}</span><br>
        CST para CClassTrib: <span class="ok">${p.cst}</span>
      </div>`;
    });
    return; // ‚ùó N√ÉO continua
  }

  // üîπ 2) BUSCA TABELA OFICIAL
  if (!carregada){
    res.innerHTML = "Carregando tabela oficial‚Ä¶";
    return;
  }

  const oficiais = tabelaNCM.filter(n =>
    (termoNum && n.ncm.startsWith(termoNum)) ||
    normalizar(n.descricao).includes(termoN)
  ).slice(0, 30);

  if (oficiais.length > 0){
    oficiais.forEach(n=>{
      res.innerHTML += `
      <div class="card">
        <strong>${n.descricao}</strong><br>
        NCM: ${n.ncm}<br>
        <span class="warn">Classifica√ß√£o tribut√°ria depende do enquadramento no CE</span>
      </div>`;
    });
  } else {
    res.innerHTML = "Nenhum resultado encontrado.";
  }
}
</script>

</body>
</html>
