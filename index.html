<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM â€¢ CClassTrib CE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
.container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px}
input{width:100%;padding:14px;font-size:16px;margin-top:10px}
.result,.error{margin-top:20px;padding:15px;border-radius:8px;display:none}
.result{background:#eef6ff}
.error{background:#fee2e2}
.small{font-size:12px;color:#555}
</style>
</head>

<body>
<div class="container">
<h2>Consulta NCM e CClassTrib â€“ CearÃ¡</h2>

<input id="busca" placeholder="Digite o produto ou NCM (ex: arroz, caneta, 22011000)">

<div id="resultado" class="result"></div>
<div id="erro" class="error"></div>
</div>

<script>
let tabelaNCM = [];
let tabelaCClass = [];

// carregar bases
Promise.all([
 fetch('tbelancm.json').then(r=>r.json()),
 fetch('cclasstrib.json').then(r=>r.json())
]).then(([ncm, cclass])=>{
 tabelaNCM = ncm;
 tabelaCClass = cclass;
});

// normalizar texto
function norm(t){
 return t.toLowerCase()
 .normalize("NFD")
 .replace(/[\u0300-\u036f]/g,"")
 .trim();
}

document.getElementById("busca").addEventListener("input", function(){
 const q = norm(this.value);
 const res = document.getElementById("resultado");
 const err = document.getElementById("erro");

 res.style.display = err.style.display = "none";
 if(q.length < 3) return;

 let produto = null;

 // ðŸ”Ž busca por NCM
 if(/^\d+$/.test(q)){
   produto = tabelaNCM.find(n => n.codigo.startsWith(q));
 }
 // ðŸ”Ž busca por descriÃ§Ã£o
 else {
   produto = tabelaNCM.find(n => norm(n.descricao).includes(q));
 }

 if(!produto){
   err.style.display = "block";
   err.innerHTML = "Nenhum resultado encontrado.";
   return;
 }

 // cruzar com CClassTrib
 let regra = tabelaCClass.find(c => produto.codigo.startsWith(c.ncm));

 let cclass = regra ? regra.cClassTrib : "000010";

 const mapaCST = {
   "000001":"000",
   "000010":"010",
   "000020":"020",
   "000030":"030",
   "000040":"040"
 };

 let cst = mapaCST[cclass] || "010";

 res.style.display = "block";
 res.innerHTML = `
 <b>Produto:</b> ${produto.descricao}<br>
 <b>NCM:</b> ${produto.codigo}<br><br>
 <b>CClassTrib (CE):</b> ${cclass}<br>
 <b>CST para CClassTrib:</b> ${cst}<br>
 <span class="small">Base NCM oficial + CClassTrib CE</span>
 `;
});
</script>
</body>
</html>
