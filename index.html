<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM • cClassTrib • Ceará</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 15px; }
h1 { text-align: center; }
input { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ccc; }
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; background: #fff; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: left; font-size: 14px; }
th { background: #2563eb; color: white; }
tr:nth-child(even) { background: #eef2f7; }
.msg { text-align: center; margin-top: 10px; font-weight: bold; color: #555; }
</style>
</head>
<body>

<h1>Consulta NCM • cClassTrib • CST</h1>

<input type="text" id="busca" placeholder="Digite: cerveja, arroz, água mineral, 22011100, ..." oninput="buscar()" />

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>NCM</th>
        <th>Descrição Oficial</th>
        <th>CST</th>
        <th>cClassTrib</th>
        <th>Descrição cClassTrib</th>
      </tr>
    </thead>
    <tbody id="resultado"></tbody>
  </table>
</div>

<div id="msg" class="msg"></div>

<script>
// Normaliza para comparações (remove acentos e caixa)
function normaliza(txt) {
  return txt.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

let ncmData = [];
let cClassData = [];

// Carrega ncm.json
fetch("ncm.json")
  .then(res => res.json())
  .then(data => {
    ncmData = data.map(item => ({
      ncm: String(item.ncm || item.NCM || item.codigo || "").padStart(8, "0"),
      descricao: item.descricao || item.Descricao || ""
    }));
  })
  .catch(() => {
    document.getElementById("msg").innerText = "Erro ao carregar ncm.json";
  });

// Carrega cclasstrib.json
fetch("cclasstrib.json")
  .then(res => res.json())
  .then(data => {
    cClassData = data;
  })
  .catch(() => {
    document.getElementById("msg").innerText = "Erro ao carregar cclasstrib.json";
  });

// Lista de termos comerciais comuns
const comercial = [
  { termos: ["agua", "mineral"], ncm: "22011000" },
  { termos: ["cerveja"], ncm: "22030000" },
  { termos: ["refrigerante"], ncm: "22021000" },
  { termos: ["arroz"], ncm: "10063021" },
  { termos: ["cachaca"], ncm: "22072020" }
];

function buscar() {
  const texto = document.getElementById("busca").value;
  const termo = normaliza(texto);
  const resultadoEl = document.getElementById("resultado");
  const msgEl = document.getElementById("msg");

  resultadoEl.innerHTML = "";
  msgEl.innerText = "";

  if (termo.length < 2) return;

  // Detecta termo numérico para NCM parcial
  const soNums = termo.replace(/\D/g, "");

  let forcarNCM = null;

  if (soNums.length >= 2) {
    // Se o usuário digitou NCM ou parte dele
    forcarNCM = soNums;
  }

  // Caso não seja número, tenta mapear nome comercial
  if (!forcarNCM) {
    for (const c of comercial) {
      if (c.termos.every(t => termo.includes(t))) {
        forcarNCM = c.ncm;
        break;
      }
    }
  }

  const encontrados = ncmData.filter(item => {
    const descNorm = normaliza(item.descricao);
    return (
      (forcarNCM && item.ncm.startsWith(forcarNCM)) ||
      descNorm.includes(termo)
    );
  });

  if (encontrados.length === 0) {
    msgEl.innerText = "Nenhum resultado encontrado";
    return;
  }

  encontrados.slice(0, 50).forEach(item => {
    // Busca cClassTrib padrão para esse NCM
    let cst = "000";
    let cclasstrib = "000001";
    let descClass = "";

    const match = cClassData.find(c => c.cclasstrib === cclasstrib);
    if (match) descClass = match.descricao;

    resultadoEl.innerHTML += `
      <tr>
        <td>${item.ncm}</td>
        <td>${item.descricao}</td>
        <td>${cst}</td>
        <td>${cclasstrib}</td>
        <td>${descClass}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
