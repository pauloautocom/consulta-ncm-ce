<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM, CST e CClassTrib</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin:20px; }
h1 { text-align:center; }
input { width:100%; padding:12px; font-size:16px; margin-bottom:15px; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px; border:1px solid #ccc; text-align:left; }
th { background:#2563eb; color:white; }
tr:nth-child(even) { background:#f1f5f9; }
.msg { padding:10px; text-align:center; color:#444; }
</style>

</head>
<body>

<h1>Consulta NCM, CST e CClassTrib</h1>

<input id="busca" placeholder="Ex: água mineral, cerveja, coca cola ou 22011000" oninput="buscar()">

<table>
<thead>
<tr>
  <th>NCM</th>
  <th>Descrição Oficial</th>
  <th>CClassTrib</th>
  <th>CST</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
// normaliza texto para comparação
function normaliza(txt) {
  return txt.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g,"")
            .trim();
}

let baseNCM = [];

// carregar o JSON
fetch("./ncm.json")
  .then(resp => resp.json())
  .then(dados => {
    // converte várias formas de campo do JSON oficial para padrão simples
    baseNCM = dados.map(i => ({
      ncm: (i.ncm || i.NCM || i.codigo || i.Codigo || "").toString().padStart(8,"0"),
      descricao: i.descricao || i.Descricao || i.DESCRICAO || ""
    }));
  })
  .catch(err => {
    document.getElementById("msg").innerText = "Erro ao carregar ncm.json — verifique se o arquivo existe e está acessível.";
  });

// mapa básico de nomes comerciais para NCM
const mapaComercial = [
  { termos:["agua","mineral"], ncm:"22011000" },
  { termos:["agua"], ncm:"22011000" },
  { termos:["refrigerante"], ncm:"22021000" },
  { termos:["coca","cola"], ncm:"22021000" },
  { termos:["cerveja"], ncm:"22030000" }
];

// regra fiscal exemplo
function getRegra(ncm) {
  return {
    cclasstrib: "000001",
    cst: "000"
  };
}

function buscar() {
  const termo = document.getElementById("busca").value;
  const termoNorm = normaliza(termo);
  const resultadosEl = document.getElementById("resultado");
  const msgEl = document.getElementById("msg");
  resultadosEl.innerHTML = "";
  msgEl.innerText = "";

  if (!termoNorm) return;

  let ncmForcado = null;

  // se for NCM numérico
  const soNums = termoNorm.replace(/\D/g,"");
  if (soNums.length >= 4) {
    ncmForcado = soNums;
  }

  // se nome comercial mapeado
  if (!ncmForcado) {
    mapaComercial.forEach(item => {
      if (item.termos.every(t => termoNorm.includes(t))) {
        ncmForcado = item.ncm;
      }
    });
  }

  const encontrados = baseNCM.filter(i => {
    const desc = normaliza(i.descricao);
    return (
      (ncmForcado && i.ncm.startsWith(ncmForcado)) ||
      desc.includes(termoNorm)
    );
  });

  if (encontrados.length === 0) {
    msgEl.innerText = "Nenhum resultado encontrado";
    return;
  }

  encontrados.slice(0,50).forEach(item => {
    const regra = getRegra(item.ncm);
    resultadosEl.innerHTML += `
      <tr>
        <td>${item.ncm}</td>
        <td>${item.descricao}</td>
        <td>${regra.cclasstrib}</td>
        <td>${regra.cst}</td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
