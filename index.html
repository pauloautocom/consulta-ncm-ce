<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM, CClassTrib e CST</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 15px; }
h1 { text-align: center; }
input { width:100%; padding:12px; font-size:16px; margin-bottom:15px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:10px; border:1px solid #ccc; font-size:14px; }
th { background:#2563eb; color:#fff; }
tr:nth-child(even){background:#eef2f7;}
.msg { text-align:center; color:#555; margin-top:10px; }
@media(max-width:600px){
    th,td { font-size:12px; }
}
</style>
</head>
<body>

<h1>Consulta NCM • CClassTrib • CST</h1>

<input id="busca" placeholder="Digite: 22011000, água, cerveja, refrigerante ..." oninput="buscar()" />

<table>
<thead>
<tr>
  <th>NCM</th>
  <th>Descrição Oficial</th>
  <th>CClassTrib</th>
  <th>CST p/ CClassTrib</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
// Normaliza para comparação
function normaliza(txt) {
  return txt.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g,"")
            .trim();
}

let baseNCM = [];

// Carrega o JSON
fetch("./ncm.json")
  .then(res => res.json())
  .then(dados => {
    baseNCM = dados.map(item => ({
      ncm: String(item.NCM || item.ncm || "").padStart(8,"0"),
      descricao: item.Descricao || item.descricao || ""
    }));
  })
  .catch(() => {
    document.getElementById("msg").innerText =
      "Erro ao carregar ncm.json — Verifique se o arquivo está acessível.";
  });

// Nomes comerciais simples para mapear
const mapaComercial = [
  { palavras:["agua","mineral"], ncm:"22011000" },
  { palavras:["agua"], ncm:"22011000" },
  { palavras:["cerveja"], ncm:"22030000" },
  { palavras:["refrigerante"], ncm:"22021000" },
  { palavras:["coca","cola"], ncm:"22021000" }
];

// Regra fiscal padrão
function regraFiscal(ncm) {
  return {
    cclasstrib:"000001",
    cst:"000"
  };
}

function buscar(){
  const valor = document.getElementById("busca").value;
  const termo = normaliza(valor);
  const tbody = document.getElementById("resultado");
  const msg = document.getElementById("msg");

  tbody.innerHTML = "";
  msg.innerText = "";

  if (termo.length < 2) return;

  let ncmForcado = null;

  // Se for NCM (numérico)
  const somenteNums = termo.replace(/\D/g,"");
  if (somenteNums.length >= 2) {
    ncmForcado = somenteNums;
  }

  // Se nome comercial identificado
  if (!ncmForcado) {
    for (const item of mapaComercial) {
      if (item.palavras.every(p => termo.includes(p))) {
        ncmForcado = item.ncm;
        break;
      }
    }
  }

  const encontrados = baseNCM.filter(item => {
    const descNorm = normaliza(item.descricao);
    return (
      (ncmForcado && item.ncm.startsWith(ncmForcado)) ||
      descNorm.includes(termo)
    );
  });

  if (encontrados.length === 0) {
    msg.innerText = "Nenhum resultado encontrado";
    return;
  }

  encontrados.forEach(item => {
    const regra = regraFiscal(item.ncm);
    tbody.innerHTML += `
<tr>
  <td>${item.ncm}</td>
  <td>${item.descricao}</td>
  <td>${regra.cclasstrib}</td>
  <td>${regra.cst}</td>
</tr>`;
  });
}
</script>

</body>
</html>
