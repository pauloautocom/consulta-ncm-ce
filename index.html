<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta NCM • cClassTrib • CE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; padding: 15px; background: #f4f6f8; }
h1 { text-align:center; font-size:22px; }
input { width:100%; padding:12px; font-size:16px; border-radius:6px; border:1px solid #ccc; margin-bottom:12px; }
table { width:100%; border-collapse:collapse; background:#fff; }
th,td { padding:10px; border:1px solid #ddd; font-size:14px; }
th { background:#2563eb; color:#fff; }
tr:nth-child(even){ background:#eef2f7; }
.msg { text-align:center; margin-top:10px; font-weight:bold; color:#b91c1c; }
@media(max-width:600px){ th,td{ font-size:12px } }
</style>
</head>

<body>
<h1>Consulta NCM • cClassTrib • CST (CE)</h1>

<input id="busca" placeholder="Digite produto ou NCM (ex: banana, 2201, camisa)" oninput="buscar()">

<table>
<thead>
<tr>
  <th>NCM</th>
  <th>Produto</th>
  <th>CST</th>
  <th>cClassTrib</th>
  <th>Descrição cClassTrib</th>
</tr>
</thead>
<tbody id="resultado"></tbody>
</table>

<div id="msg" class="msg"></div>

<script>
async function carregarJSON(url){ 
  const r = await fetch(url); 
  return r.ok ? await r.json() : [];
}

// normaliza texto
function norm(t){
  return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

let produtos = [];
let cclass = [];

// carrega dados
(async()=>{
  produtos = await carregarJSON("produtos.json");
  cclass = await carregarJSON("cclasstrib.json");
})();

// regra padrão fiscal (CE)
function regraFiscal(ncm){
  // padrão mercantil
  return {
    cst: "000",
    cclass: "000001"
  };
}

function buscar(){
  const termo = norm(document.getElementById("busca").value);
  const res = document.getElementById("resultado");
  const msg = document.getElementById("msg");
  res.innerHTML = "";
  msg.innerText = "";

  if(termo.length < 2) return;

  const num = termo.replace(/\D/g,"");
  const achados = produtos.filter(p => {
    return (
      (num && p.ncm.startsWith(num)) ||
      norm(p.nome).includes(termo)
    );
  });

  if(!achados.length){
    msg.innerText = "Nenhum resultado encontrado";
    return;
  }

  achados.forEach(p => {
    const regra = regraFiscal(p.ncm);
    const desc = (cclass.find(c=>c.cclasstrib===regra.cclass) || {}).descricao || "";

    res.innerHTML += `
<tr>
  <td>${p.ncm}</td>
  <td>${p.nome}</td>
  <td>${regra.cst}</td>
  <td>${regra.cclass}</td>
  <td>${desc}</td>
</tr>`;
  });
}
</script>

</body>
</html>
